# Story 2.4: Firestore Data Integration

## Status
Draft

## Story
As a user,
I want my notes to be automatically synchronized across devices,
so that I can access my work from anywhere.

## Acceptance Criteria
1. Implement Firestore data models for notebooks, pages, and content
2. Create real-time listeners for data synchronization
3. Implement offline data persistence with Firebase offline support
4. Add data validation and error handling for Firestore operations
5. Create efficient data queries for notebook and page retrieval
6. Implement data security rules for user data protection
7. Add data migration and cleanup utilities
8. Create data backup and restore functionality
9. Implement data compression for large content
10. Add performance monitoring for data operations

## Tasks / Subtasks
- [ ] Firestore data models and schemas (AC: 1, 4)
  - [ ] Design Firestore collection structure for notebooks, pages, and content
  - [ ] Create Zod schemas for data validation matching architecture patterns
  - [ ] Implement TypeScript interfaces for all data models
  - [ ] Add data validation middleware for all Firestore operations
  - [ ] Create data transformation utilities for Google Drive sync compatibility
- [ ] Real-time synchronization (AC: 2, 5)
  - [ ] Implement Firestore real-time listeners for notebooks and pages
  - [ ] Create efficient query patterns for notebook and page retrieval
  - [ ] Add real-time updates for collaborative editing scenarios
  - [ ] Implement query optimization with proper indexing strategies
  - [ ] Create data synchronization state management
- [ ] Offline data persistence (AC: 3)
  - [ ] Configure Firebase offline persistence for Firestore
  - [ ] Implement IndexedDB integration with Firestore offline support
  - [ ] Create offline queue management for pending operations
  - [ ] Add conflict resolution for offline/online data synchronization
  - [ ] Implement data reconciliation on connection restoration
- [ ] Data security and validation (AC: 4, 6)
  - [ ] Implement Firestore security rules for user data protection
  - [ ] Add comprehensive error handling for all Firestore operations
  - [ ] Create data validation pipelines with Zod schemas
  - [ ] Implement user authentication checks for all data operations
  - [ ] Add data sanitization and input validation
- [ ] Data management utilities (AC: 7, 8)
  - [ ] Create data migration utilities for schema changes
  - [ ] Implement data cleanup utilities for orphaned records
  - [ ] Add data backup functionality with Google Drive integration
  - [ ] Create data restore functionality from backups
  - [ ] Implement data export/import capabilities
- [ ] Performance optimization (AC: 9, 10)
  - [ ] Implement data compression for large content storage
  - [ ] Add performance monitoring for Firestore operations
  - [ ] Create query performance analytics and optimization
  - [ ] Implement caching strategies for frequently accessed data
  - [ ] Add memory usage monitoring and optimization

## Dev Notes

### Architecture Alignment
- **Tech Stack**: React + TypeScript with Firebase Firestore integration as specified in architecture [Source: architecture/biblion-architecture-frontend-only-google-drive-storage-pwa-ready.md#tech-stack]
- **Storage Strategy**: Primary IndexedDB for fast local operations, Firestore for real-time sync, Google Drive as source of truth [Source: architecture/biblion-architecture-frontend-only-google-drive-storage-pwa-ready.md#storage-strategy]
- **Component Structure**: Follow `/src/features/data/` and `/src/features/sync/` organization [Source: architecture/biblion-architecture-frontend-only-google-drive-storage-pwa-ready.md#project-folder-structure]
- **PWA Compatibility**: Ensure Firestore operations work offline and sync when online [Source: architecture/biblion-architecture-frontend-only-google-drive-storage-pwa-ready.md#pwa-plan]

### UI Design Specifications (from Figma)
- **Figma Design File**: https://www.figma.com/design/J4Dsi0o3FCgCgqrvPCAehY/Untitled?node-id=43-1195&t=fKz1X7GM7fkQ2MQD-0
- **Three-column layout**: Notebooks (left), Notes (middle), Content (right) as shown in Figma designs
- **Real-time sync indicators**: Integrate sync status with existing toolbar design, use consistent color scheme (white background, grey text, yellow accents)
- **Data loading states**: Skeleton screens and loading indicators matching the minimalist design language
- **Error handling UI**: Toast notifications and inline error messages consistent with Material UI theming
- **Modal dialogs**: "New Notebook" and "Create New Note" modals with form validation and submission handling
- **Sync status positioning**: Integrate with existing toolbar area, maintain consistent spacing and typography

### Technical Implementation
- **Firestore Configuration**: Use Firebase v10.12.2 with offline persistence enabled [Source: architecture/biblion-architecture-frontend-only-google-drive-storage-pwa-ready.md#library-versions]
- **Data Validation**: Use Zod v3.22.4 for runtime validation of all data models [Source: architecture/biblion-architecture-frontend-only-google-drive-storage-pwa-ready.md#library-versions]
- **Local Storage**: Leverage IndexedDB via idb v8.0.0 for offline data persistence [Source: architecture/biblion-architecture-frontend-only-google-drive-storage-pwa-ready.md#library-versions]
- **Sync Strategy**: Implement two-way sync with conflict resolution using revisionId approach [Source: architecture/biblion-architecture-frontend-only-google-drive-storage-pwa-ready.md#sync-flow]

### Data Models
```typescript
// Firestore user config document
interface UserConfig {
  selectedFolder: {
    id: string;           // Drive folderId (canonical)
    name?: string;        // display-only
    breadcrumb?: string[];
    updatedAt: Timestamp;
  }
}

// Notebook data model
interface Notebook {
  id: string;
  title: string;
  description?: string;
  createdAt: Timestamp;
  updatedAt: Timestamp;
  userId: string;
  revisionId: string;
  isPinned: boolean;
}

// Page data model
interface Page {
  id: string;
  notebookId: string;
  title: string;
  content: string;
  createdAt: Timestamp;
  updatedAt: Timestamp;
  userId: string;
  revisionId: string;
  isPinned: boolean;
  parentPageId?: string; // for hierarchical structure
}

// Sync status model
interface SyncStatus {
  state: 'idle' | 'syncing' | 'synced' | 'error';
  lastSync?: Date;
  error?: string;
  pendingOperations: number;
}
```

### File Locations
- **Firestore Service**: `/src/features/data/firestore-service.ts`
- **Data Models**: `/src/features/data/models/`
- **Sync Manager**: `/src/features/sync/sync-manager.ts`
- **Data Validation**: `/src/features/data/validation/`
- **Security Rules**: `/firestore.rules`
- **Data Schemas**: `/src/features/data/schemas/`

### Testing
- **Unit Tests**: 
  - Firestore data model validation and transformation
  - Real-time listener setup and cleanup
  - Offline persistence and conflict resolution
  - Data security rule validation
- **Component Tests**: 
  - Real-time data updates in UI components
  - Sync status indicator rendering and state changes
  - Error handling and user feedback
  - Loading states and skeleton screens
- **Integration Tests**: 
  - End-to-end Firestore sync with Google Drive
  - Offline/online data reconciliation
  - Multi-device synchronization scenarios
  - Data migration and cleanup operations
- **Performance Tests**: 
  - Firestore query performance with large datasets
  - Real-time listener performance and memory usage
  - Data compression effectiveness
  - Offline operation queue management

### Previous Story Insights
- Story 2.3 established auto-save and version control infrastructure that should integrate with Firestore sync
- Real-time sync should work seamlessly with the 2-second auto-save intervals from 2.3
- Version history from 2.3 should be stored in Firestore for cross-device access
- Conflict resolution from 2.3 should be enhanced with Firestore real-time capabilities
- Figma design system and three-column layout from previous stories should be maintained for sync status indicators

## Change Log
| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| 2024-12-20 | 0.1 | Initial draft created from PRD Epic 2 Story 2.4 with Figma design integration | Scrum Master |
