# Story 2.3: Real-time Auto-save and Version Control

## Status
Draft

## Story
As a user,
I want my notes to be automatically saved and have version history,
so that I never lose my work and can recover previous versions.

## Acceptance Criteria
1. Implement real-time auto-save every 2 seconds
2. Create version history system with restore points
3. Add visual indicators for save status (saving, saved, error)
4. Implement offline draft protection with local storage
5. Create page recovery system for lost content
6. Add conflict resolution for simultaneous edits
7. Implement version comparison and diff viewing
8. Create manual save trigger for immediate saving
9. Add version history cleanup for old versions
10. Store version data in Firestore with proper indexing

## Tasks / Subtasks
- [ ] Auto-save infrastructure (AC: 1, 4, 8)
  - [ ] Implement debounced auto-save mechanism with 2-second intervals
  - [ ] Create local storage backup system for offline protection
  - [ ] Add manual save trigger with keyboard shortcut (Ctrl/Cmd+S)
  - [ ] Implement save queue management for batch operations
  - [ ] Create save state management with proper error handling
- [ ] Visual save status indicators (AC: 3)
  - [ ] Design save status UI components matching Figma design
  - [ ] Implement "saving" indicator with spinner animation
  - [ ] Add "saved" confirmation with checkmark icon
  - [ ] Create "error" state with retry functionality
  - [ ] Position status indicators in toolbar area per Figma layout
- [ ] Version history system (AC: 2, 9)
  - [ ] Create version data model with timestamps and content snapshots
  - [ ] Implement version creation on significant changes
  - [ ] Add version history cleanup (keep last 50 versions per page)
  - [ ] Create version metadata (author, change summary, file size)
  - [ ] Implement efficient version storage with compression
- [ ] Version restoration (AC: 2, 5)
  - [ ] Create version selection UI with timeline view
  - [ ] Implement restore functionality with confirmation dialog
  - [ ] Add page recovery system for lost content scenarios
  - [ ] Create backup restoration from local storage
  - [ ] Implement rollback with proper state management
- [ ] Conflict resolution (AC: 6)
  - [ ] Implement conflict detection for simultaneous edits
  - [ ] Create conflict resolution UI with side-by-side comparison
  - [ ] Add automatic conflict resolution strategies
  - [ ] Implement user choice resolution interface
  - [ ] Create conflict logging and notification system
- [ ] Version comparison and diff (AC: 7)
  - [ ] Implement text diff algorithm for content comparison
  - [ ] Create side-by-side version comparison UI
  - [ ] Add highlighting for added/removed/modified content
  - [ ] Implement word-level and character-level diff views
  - [ ] Create diff export functionality
- [ ] Firestore integration (AC: 10)
  - [ ] Design version data schema for Firestore storage
  - [ ] Implement efficient version queries with proper indexing
  - [ ] Add version data validation and error handling
  - [ ] Create version synchronization with Google Drive
  - [ ] Implement version data security rules

## Dev Notes

### Architecture Alignment
- **Tech Stack**: React + TypeScript with Material UI components as specified in architecture [Source: architecture/biblion-architecture-frontend-only-google-drive-storage-pwa-ready.md#tech-stack]
- **Storage Strategy**: Primary IndexedDB for fast local operations, Google Drive as source of truth [Source: architecture/biblion-architecture-frontend-only-google-drive-storage-pwa-ready.md#storage-strategy]
- **Component Structure**: Follow `/src/components/ui/` and `/src/features/sync/` organization [Source: architecture/biblion-architecture-frontend-only-google-drive-storage-pwa-ready.md#project-folder-structure]
- **PWA Compatibility**: Ensure auto-save works offline and syncs when online [Source: architecture/biblion-architecture-frontend-only-google-drive-storage-pwa-ready.md#pwa-plan]

### UI Design Specifications (from Figma)
- Figma reference: https://www.figma.com/design/J4Dsi0o3FCgCgqrvPCAehY/Untitled?node-id=0-1&p=f&t=gSPHBVvqhylH2kw5-0
- **Save Status Indicators**: Integrate with existing toolbar design, use consistent color scheme (white background, grey text, yellow accents)
- **Version History UI**: Modal or sidebar panel matching three-column layout design language
- **Conflict Resolution**: Overlay or modal with clear visual distinction for conflicting content
- **Status Positioning**: Save indicators in toolbar area, version controls accessible via menu or dedicated panel

### Technical Implementation
- **Auto-save Strategy**: Use debounced approach with 2-second intervals, triggered by content changes
- **Local Storage**: Leverage IndexedDB for offline draft protection using idb library [Source: architecture/biblion-architecture-frontend-only-google-drive-storage-pwa-ready.md#tech-stack]
- **Version Storage**: Store versions as JSON files in Google Drive with efficient compression
- **Conflict Detection**: Use revisionId/E-Tag approach as specified in sync flow [Source: architecture/biblion-architecture-frontend-only-google-drive-storage-pwa-ready.md#sync-flow]
- **Data Models**: Use Zod schemas for version data validation [Source: architecture/biblion-architecture-frontend-only-google-drive-storage-pwa-ready.md#tech-stack]

### Data Models
```typescript
// Version data model
interface VersionData {
  id: string;
  pageId: string;
  content: string;
  timestamp: Date;
  author: string;
  changeSummary?: string;
  fileSize: number;
  revisionId: string;
}

// Save status model
interface SaveStatus {
  state: 'idle' | 'saving' | 'saved' | 'error';
  lastSaved?: Date;
  error?: string;
  retryCount: number;
}
```

### File Locations
- **Auto-save Service**: `/src/features/sync/auto-save.ts`
- **Version Management**: `/src/features/sync/version-manager.ts`
- **Save Status Components**: `/src/components/ui/save-status.tsx`
- **Version History UI**: `/src/components/ui/version-history.tsx`
- **Conflict Resolution**: `/src/components/ui/conflict-resolver.tsx`
- **Version Schemas**: `/src/features/data/schemas/version.ts`

### Testing
- **Unit Tests**: 
  - Auto-save debouncing and timing behavior
  - Version creation and cleanup logic
  - Conflict detection algorithms
  - Save status state management
- **Component Tests**: 
  - Save status indicator rendering and state changes
  - Version history UI interactions
  - Conflict resolution dialog functionality
  - Manual save trigger behavior
- **Integration Tests**: 
  - End-to-end auto-save flow with Firestore
  - Version restoration with content validation
  - Offline/online sync behavior
  - Conflict resolution scenarios
- **Performance Tests**: 
  - Auto-save performance with large documents
  - Version storage and retrieval efficiency
  - Memory usage with multiple versions

### Previous Story Insights
- Story 2.2 established the three-column layout and rich text editor foundation
- Editor framework selection (TipTap/ProseMirror) should be consistent with auto-save implementation
- Material UI theming and responsive design patterns established in 2.2 should be maintained
- Figma design system and color scheme should be consistently applied to version control UI

## Change Log
| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| 2025-09-10 | 0.1 | Initial draft created from PRD Epic 2 Story 2.3 with Figma design integration | Scrum Master |

