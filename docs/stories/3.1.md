# Story 3.1: Google Drive API Integration

## Status
Draft

## Story
As a user,
I want to connect my Google Drive account and select folders for note storage,
so that my notes are backed up to my personal Google Drive.

## Acceptance Criteria
1. Implement Google Drive API v3 integration with proper authentication
2. Create folder selection interface for choosing Google Drive storage location
3. Add Google Drive authentication flow with proper scopes
4. Implement folder browsing and selection functionality
5. Create folder permission validation and error handling
6. Add Google Drive quota monitoring and warnings
7. Implement file creation and update operations in Google Drive
8. Persist the selected folderId in Firestore under `users/{uid}.selectedFolder` with `updatedAt`
9. Cache selected folder locally and reconcile with Firestore on startup
10. Create Google Drive file metadata management
11. Add Google Drive API rate limiting and retry logic
12. Implement Google Drive file conflict detection

## Tasks / Subtasks
- [ ] Google Drive API integration (AC: 1, 11)
  - [ ] Set up Google Drive API v3 client with proper authentication
  - [ ] Implement OAuth2 flow with Firebase Authentication integration
  - [ ] Add Google Drive API rate limiting and exponential backoff retry logic
  - [ ] Create API error handling and user-friendly error messages
  - [ ] Implement token refresh and authentication state management
- [ ] Authentication and scopes (AC: 3)
  - [ ] Configure GoogleAuthProvider with Drive App Data and Drive File scopes
  - [ ] Implement signInWithPopup flow for Google Drive access
  - [ ] Extract OAuth access token for Drive API calls
  - [ ] Add authentication state persistence and validation
  - [ ] Create authentication error handling and re-authentication flow
- [ ] Folder selection interface (AC: 2, 4, 5)
  - [ ] Create "Connect to Drive" modal dialog matching Figma design
  - [ ] Implement folder browsing interface with folder list display
  - [ ] Add folder selection functionality with visual feedback
  - [ ] Create folder permission validation and error handling
  - [ ] Implement folder search and filtering capabilities
- [ ] Data persistence and caching (AC: 8, 9)
  - [ ] Implement Firestore user config document structure
  - [ ] Create local caching of selected folder with IndexedDB
  - [ ] Add startup reconciliation between local cache and Firestore
  - [ ] Implement folder metadata synchronization
  - [ ] Create data validation and error recovery mechanisms
- [ ] File operations and metadata (AC: 7, 10)
  - [ ] Implement Google Drive file creation and update operations
  - [ ] Create file metadata management system
  - [ ] Add file naming conventions and organization structure
  - [ ] Implement file versioning and revision tracking
  - [ ] Create file conflict detection and resolution preparation
- [ ] Monitoring and validation (AC: 6, 12)
  - [ ] Add Google Drive quota monitoring and user warnings
  - [ ] Implement file conflict detection algorithms
  - [ ] Create sync status monitoring and reporting
  - [ ] Add performance monitoring for API operations
  - [ ] Implement data integrity validation

## Dev Notes

### Architecture Alignment
- **Tech Stack**: React + TypeScript with Firebase Authentication and Google Drive API v3 integration [Source: architecture/biblion-architecture-frontend-only-google-drive-storage-pwa-ready.md#tech-stack]
- **Authentication Strategy**: Firebase Authentication with Google provider requesting Drive scopes [Source: architecture/biblion-architecture-frontend-only-google-drive-storage-pwa-ready.md#firebase-integration]
- **Storage Strategy**: Google Drive as source of truth with local IndexedDB caching [Source: architecture/biblion-architecture-frontend-only-google-drive-storage-pwa-ready.md#storage-strategy]
- **Component Structure**: Follow `/src/features/auth/` and `/src/features/data/` organization [Source: architecture/biblion-architecture-frontend-only-google-drive-storage-pwa-ready.md#project-folder-structure]

### UI Design Specifications (from Figma)
- **Figma Design File**: https://www.figma.com/design/J4Dsi0o3FCgCgqrvPCAehY/Untitled?node-id=43-1195&t=fKz1X7GM7fkQ2MQD-0
- **Connect to Drive Modal**: Clean white interface with dark grey text and yellow "Connect" button
- **Folder Selection Interface**: List of folders with folder icons, names, and last modified dates
- **Visual Feedback**: Checkmark icons for selected folders, consistent spacing and typography
- **Error Handling**: User-friendly error messages and validation feedback
- **Loading States**: Skeleton screens and loading indicators during folder browsing
- **Responsive Design**: Maintain consistent design language across different screen sizes

### Technical Implementation
- **Google Drive API**: Use Google Drive API v3 with proper OAuth2 authentication [Source: architecture/biblion-architecture-frontend-only-google-drive-storage-pwa-ready.md#firebase-integration]
- **Authentication Scopes**: Request `https://www.googleapis.com/auth/drive.appdata` and `https://www.googleapis.com/auth/drive.file` scopes [Source: architecture/biblion-architecture-frontend-only-google-drive-storage-pwa-ready.md#firebase-integration]
- **Token Management**: Extract access token via `GoogleAuthProvider.credentialFromResult(result)?.accessToken` [Source: architecture/biblion-architecture-frontend-only-google-drive-storage-pwa-ready.md#firebase-integration]
- **Data Validation**: Use Zod v3.22.4 for runtime validation of Google Drive responses [Source: architecture/biblion-architecture-frontend-only-google-drive-storage-pwa-ready.md#library-versions]

### Data Models
```typescript
// User config document in Firestore
interface UserConfig {
  selectedFolder: {
    id: string;           // Drive folderId (canonical)
    name?: string;        // display-only
    breadcrumb?: string[];
    updatedAt: Timestamp;
  }
}

// Google Drive folder model
interface DriveFolder {
  id: string;
  name: string;
  lastModified: Date;
  permissions: string[];
  isSelectable: boolean;
  breadcrumb: string[];
}

// Google Drive API response model
interface DriveFile {
  id: string;
  name: string;
  mimeType: string;
  modifiedTime: string;
  size?: string;
  parents?: string[];
  webViewLink?: string;
}

// Authentication state model
interface AuthState {
  isAuthenticated: boolean;
  accessToken?: string;
  selectedFolder?: DriveFolder;
  lastSync?: Date;
  error?: string;
}
```

### File Locations
- **Google Drive Service**: `/src/features/data/google-drive-service.ts`
- **Authentication Module**: `/src/features/auth/google-drive-auth.ts`
- **Folder Selection UI**: `/src/components/ui/folder-selector.tsx`
- **Connect Drive Modal**: `/src/components/ui/connect-drive-modal.tsx`
- **User Config Service**: `/src/features/data/user-config-service.ts`
- **Drive API Client**: `/src/lib/google-drive-client.ts`

### Testing
- **Unit Tests**: 
  - Google Drive API client authentication and token management
  - Folder selection and validation logic
  - User config persistence and caching
  - API rate limiting and retry mechanisms
- **Component Tests**: 
  - Connect to Drive modal rendering and interactions
  - Folder selection interface and user feedback
  - Authentication flow and error handling
  - Loading states and skeleton screens
- **Integration Tests**: 
  - End-to-end Google Drive authentication flow
  - Folder selection and persistence in Firestore
  - API quota monitoring and error scenarios
  - Multi-device folder synchronization
- **Performance Tests**: 
  - Google Drive API response times and caching
  - Large folder list rendering performance
  - Authentication token refresh efficiency
  - Memory usage with multiple API calls

### Previous Story Insights
- Story 2.4 established Firestore data integration that should seamlessly connect with Google Drive folder selection
- User config document structure from 2.4 should be extended to include selected folder information
- Real-time sync capabilities from 2.4 should integrate with Google Drive file operations
- Figma design system and modal patterns from previous stories should be maintained for consistency
- Authentication flow should integrate with existing Firebase Authentication setup from Epic 1

## Change Log
| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| 2024-12-20 | 0.1 | Initial draft created from PRD Epic 3 Story 3.1 with Figma design integration | Scrum Master |
